name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      - name: Install Moltbot CLI (via npm)
        run: |
          npm install -g clawdbot
          # Ensure it's in path (setup-node should handle this, but explicit check doesn't hurt)
          clawdbot --version
          # Alias moltbot to clawdbot for compatibility with our scripts if needed
          if ! command -v moltbot &> /dev/null; then
            sudo ln -s $(which clawdbot) /usr/local/bin/moltbot
          fi

      - name: Syntax Check (bash)
        run: bash -n scripts/*.sh

      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'

      - name: Secret Scan (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Config (No Token Mode)
        # We run health check. It might fail connectivity to Telegram, but should validate schema.
        run: |
          ./scripts/bootstrap.sh
          # Attempt to run verify. It returns exit code of health check.
          # Since we don't have valid tokens, we expect it might fail "start", but we want to check schema validity.
          # Moltbot `doctor` is good for static analysis.
          moltbot doctor
